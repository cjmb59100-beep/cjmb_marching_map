<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ãƒãƒ¼ãƒãƒ³ã‚°ãƒãƒ³ãƒ‰ãƒãƒƒãƒ—</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon.png">
    
    <!-- Apple Touch Icon (iPhone/iPad ãƒ›ãƒ¼ãƒ ç”»é¢ã‚¢ã‚¤ã‚³ãƒ³) -->
    <link rel="apple-touch-icon" href="favicon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="favicon.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #10B981;
            --primary-dark: #059669;
            --secondary: #34D399;
            --accent: #6EE7B7;
            --bg: #F0FDF4;
            --card-bg: #FFFFFF;
            --text: #064E3B;
            --text-light: #047857;
            --text-muted: #6B7280;
            --overlay: rgba(16, 185, 129, 0.95);
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #map {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .controls-overlay {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 15px;
            animation: fadeInDown 0.6s ease-out;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .add-school-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .add-school-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(16, 185, 129, 0.4);
        }

        .add-school-btn::before {
            content: '+';
            font-size: 1.5rem;
            font-weight: bold;
        }

        .zoom-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .zoom-btn {
            width: 50px;
            height: 50px;
            background: var(--card-bg);
            border: 2px solid var(--primary);
            border-radius: 12px;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            touch-action: manipulation; /* ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‚ºãƒ¼ãƒ ã‚’é˜²æ­¢ */
        }

        .zoom-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.05);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 24px;
            padding: 2.5rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.4s ease-out;
            border: 3px solid var(--primary);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .modal-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close-btn:hover {
            background: var(--bg);
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text);
            font-weight: 700;
            font-size: 0.9rem;
        }

        input, textarea {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg);
            border: 2px solid #D1FAE5;
            border-radius: 12px;
            color: var(--text);
            font-family: 'Noto Sans JP', sans-serif;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: none;
            border-radius: 12px;
            color: white;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(16, 185, 129, 0.3);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(16, 185, 129, 0.4);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .password-section {
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 2px solid #F59E0B;
        }

        .password-section p {
            color: #92400E;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .leaflet-popup-content-wrapper {
            background: var(--card-bg);
            color: var(--text);
            border-radius: 16px;
            padding: 0;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            border: 3px solid var(--primary);
            min-width: 280px;
        }

        .leaflet-popup-content {
            margin: 0 !important;
            padding: 0 !important;
            width: auto !important;
        }

        .popup-content {
            padding: 1rem 1.2rem 0.8rem 1.2rem;  /* ä¸Š å³ ä¸‹ å·¦ */
        }

        .popup-title {
            font-family: 'Montserrat', sans-serif;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.6rem;
        }

        .popup-description {
            color: var(--text-muted);
            margin-bottom: 0.8rem;
            line-height: 1.6;
            font-size: 0.9rem;
        }

        .popup-thumbnail {
            width: 100%;
            aspect-ratio: 16 / 9;  /* 16:9ã®ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã«å›ºå®š */
            display: block;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            object-fit: cover;  /* ç”»åƒã‚’æ ã„ã£ã±ã„ã«è¡¨ç¤º */
            background: #000;  /* ãƒ­ãƒ¼ãƒ‰ä¸­ã®èƒŒæ™¯ */
        }

        .popup-thumbnail:hover {
            transform: scale(1.03);
            box-shadow: 0 8px 30px rgba(16, 185, 129, 0.3);
        }
        
        /* YouTubeã‚¿ã‚¤ãƒˆãƒ« */
        .youtube-title-text {
            margin-top: 6px;
            margin-bottom: 0;
            padding-bottom: 0;
            font-size: 9.75px;  /* 13px Ã— 0.75 = 9.75px */
            color: #374151;
            line-height: 1.3;  /* è¡Œé–“ã‚’è©°ã‚ã‚‹ */
            font-weight: 500;
            pointer-events: none;  /* ã‚¯ãƒªãƒƒã‚¯ä¸å¯ */
            user-select: text;  /* ãƒ†ã‚­ã‚¹ãƒˆé¸æŠã¯å¯èƒ½ */
        }

        .leaflet-popup-tip {
            background: var(--card-bg);
            border: 3px solid var(--primary);
            border-top: none;
            border-right: none;
        }

        .custom-marker {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.5);
        }
        
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ç”¨ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        .custom-cluster-icon {
            background: transparent !important;
            border: none !important;
        }
        
        .custom-cluster-icon div {
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .custom-cluster-icon div:hover {
            transform: scale(1.1);
        }
        
        /* ãƒãƒ¼ã‚«ãƒ¼ãƒ©ãƒ™ãƒ«ï¼ˆå­¦æ ¡åï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .marker-label {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid var(--primary);
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 600;
            color: var(--primary-dark);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            white-space: nowrap;
            font-family: 'Noto Sans JP', sans-serif;
        }
        
        .marker-label::before {
            display: none; /* çŸ¢å°ã‚’éè¡¨ç¤º */
        }
        
        /* å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .delete-mode-indicator {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #DC2626 0%, #991B1B 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 16px;
            box-shadow: 0 8px 30px rgba(220, 38, 38, 0.5);
            z-index: 10000;
            display: none;
            animation: slideDown 0.3s ease-out;
        }
        
        .delete-mode-indicator.active {
            display: block;
        }
        
        /* ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
        .edit-mode-indicator {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #2563EB 0%, #1E40AF 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 16px;
            box-shadow: 0 8px 30px rgba(37, 99, 235, 0.5);
            z-index: 10000;
            display: none;
            animation: slideDown 0.3s ease-out;
        }
        
        .edit-mode-indicator.active {
            display: block;
        }
        
        /* å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« */
        .delete-confirm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 20000;
            align-items: center;
            justify-content: center;
        }
        
        .delete-confirm-modal.active {
            display: flex;
        }
        
        .delete-confirm-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            text-align: center;
        }
        
        .delete-confirm-title {
            font-size: 20px;
            font-weight: 700;
            color: #DC2626;
            margin-bottom: 15px;
        }
        
        .delete-confirm-message {
            font-size: 16px;
            color: #374151;
            margin-bottom: 25px;
        }
        
        .delete-confirm-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .delete-confirm-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .delete-confirm-btn.confirm {
            background: #DC2626;
            color: white;
        }
        
        .delete-confirm-btn.confirm:hover {
            background: #991B1B;
        }
        
        .delete-confirm-btn.cancel {
            background: #E5E7EB;
            color: #374151;
        }
        
        .delete-confirm-btn.cancel:hover {
            background: #D1D5DB;
        }
        
        /* ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« */
        .password-confirm-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 20000;
            align-items: center;
            justify-content: center;
        }
        
        .password-confirm-modal.active {
            display: flex;
        }
        
        .password-confirm-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
        }
        
        .password-confirm-title {
            font-size: 20px;
            font-weight: 700;
            color: #DC2626;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .password-confirm-description {
            font-size: 14px;
            color: #6B7280;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .password-confirm-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #E5E7EB;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 10px;
            transition: border-color 0.3s ease;
        }
        
        .password-confirm-input:focus {
            outline: none;
            border-color: #DC2626;
        }
        
        .password-confirm-error {
            color: #DC2626;
            font-size: 14px;
            margin-bottom: 15px;
            display: none;
            text-align: center;
        }
        
        .password-confirm-error.active {
            display: block;
        }
        
        .password-confirm-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .password-confirm-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .password-confirm-btn.confirm {
            background: #DC2626;
            color: white;
        }
        
        .password-confirm-btn.confirm:hover {
            background: #991B1B;
        }
        
        .password-confirm-btn.cancel {
            background: #E5E7EB;
            color: #374151;
        }
        
        .password-confirm-btn.cancel:hover {
            background: #D1D5DB;
        }
        
        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        
        /* å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ãƒãƒ¼ã‚«ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ« */
        .delete-mode .custom-marker {
            background: linear-gradient(135deg, #DC2626 0%, #991B1B 100%);
            cursor: pointer;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 4px 12px rgba(220, 38, 38, 0.5);
            }
            50% {
                box-shadow: 0 6px 20px rgba(220, 38, 38, 0.8);
            }
        }

        /* ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…å®¹è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« */
        .cluster-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 3000;
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }

        .cluster-modal.active {
            display: flex;
        }

        .cluster-modal-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
            display: flex;
            flex-direction: column;
        }

        .cluster-modal-header {
            padding: 20px 30px;
            border-bottom: 2px solid var(--card-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cluster-modal-header h3 {
            font-family: 'Noto Sans JP', sans-serif;
            font-size: 1.5rem;
            color: var(--primary-dark);
            margin: 0;
        }

        .close-cluster-modal {
            background: none;
            border: none;
            font-size: 2rem;
            color: #999;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close-cluster-modal:hover {
            background: var(--card-bg);
            color: var(--primary);
        }

        .cluster-modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .cluster-school-item {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .cluster-school-item:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.2);
        }

        .cluster-school-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--primary-dark);
            margin-bottom: 8px;
            font-family: 'Noto Sans JP', sans-serif;
        }

        .cluster-school-description {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .cluster-school-thumbnail {
            width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 10px;
        }

        .error-message {
            background: #FEE2E2;
            border: 2px solid #DC2626;
            color: #991B1B;
            padding: 1rem;
            border-radius: 12px;
            margin-top: 1rem;
            display: none;
            font-weight: 600;
        }

        .success-message {
            background: #D1FAE5;
            border: 2px solid var(--primary);
            color: var(--primary-dark);
            padding: 1rem;
            border-radius: 12px;
            margin-top: 1rem;
            display: none;
            font-weight: 600;
        }

        .leaflet-control-zoom {
            display: none !important;
        }
        
        /* ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒœã‚¿ãƒ³ã¨ãƒ‘ãƒãƒ« */
        .filter-overlay {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
        }
        
        /* ãƒ­ã‚´ï¼ˆãƒ›ãƒ¼ãƒ ãƒœã‚¿ãƒ³ï¼‰ */
        .logo-home {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 16px;  /* è§’ã‚’ä¸¸ã */
            overflow: hidden;  /* è§’ä¸¸ã‚’æœ‰åŠ¹ã«ã™ã‚‹ */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            touch-action: manipulation; /* ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‚ºãƒ¼ãƒ ã‚’é˜²æ­¢ */
        }
        
        .logo-home:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        .logo-home img {
            display: block;
            width: 300px;  /* æ¨ªé•·ãƒãƒŠãƒ¼ãªã®ã§å¹…ã§æŒ‡å®š */
            height: auto;
        }
        
        /* ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹ã¨ãã®ç™½ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ */
        .white-flash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 9999;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .white-flash.active {
            opacity: 1;
        }
        
        .filter-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            touch-action: manipulation; /* ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‚ºãƒ¼ãƒ ã‚’é˜²æ­¢ */
        }
        
        .filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(16, 185, 129, 0.4);
        }
        
        .filter-btn::before {
            content: 'ğŸ”';
            font-size: 1.2rem;
        }
        
        .filter-panel {
            position: absolute;
            bottom: 70px;
            left: 0;
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            min-width: 250px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            touch-action: manipulation; /* ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‚ºãƒ¼ãƒ ã‚’é˜²æ­¢ */
        }
        
        .filter-panel.active {
            display: block;
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .filter-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
        }
        
        .filter-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            touch-action: manipulation; /* ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‚ºãƒ¼ãƒ ã‚’é˜²æ­¢ */
        }
        
        .filter-item:hover {
            background: #F0FDF4;
        }
        
        .filter-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--primary);
            border-radius: 6px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .filter-item.active .filter-checkbox {
            background: var(--primary);
        }
        
        .filter-checkbox::after {
            content: 'âœ“';
            color: white;
            font-weight: 700;
            font-size: 14px;
            display: none;
        }
        
        .filter-item.active .filter-checkbox::after {
            display: block;
        }
        
        .filter-label {
            font-size: 15px;
            font-weight: 600;
            color: #374151;
        }
        
        .filter-count {
            margin-left: auto;
            font-size: 13px;
            color: #9CA3AF;
            font-weight: 600;
        }
        
        .filter-clear-btn {
            width: 100%;
            padding: 10px;
            background: #F3F4F6;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            color: #6B7280;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.3s ease;
            touch-action: manipulation; /* ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‚ºãƒ¼ãƒ ã‚’é˜²æ­¢ */
        }
        
        .filter-clear-btn:hover {
            background: #E5E7EB;
        }

        @media (max-width: 768px) {
            /* ãƒ­ã‚´ã‚’ã‚¹ãƒãƒ›ã§50%ç¸®å° */
            .logo-home {
                top: 15px;
                left: 15px;
            }
            
            .logo-home img {
                width: 150px;  /* 300px Ã— 50% = 150px */
                height: auto;
            }
            
            /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å…¨ä½“ã‚’75%ç¸®å° */
            .leaflet-popup-content-wrapper {
                transform: scale(0.75);
                transform-origin: top center;
            }
            
            .leaflet-popup-tip-container {
                transform: scale(0.75);
                transform-origin: top center;
            }
            
            .leaflet-popup-content {
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .controls-overlay {
                top: 15px;
                right: 15px;
                gap: 10px;
            }

            .add-school-btn {
                padding: 12px 20px;
                font-size: 0.9rem;
            }

            .zoom-btn {
                width: 45px;
                height: 45px;
                font-size: 1.3rem;
            }

            .modal-content {
                padding: 2rem;
            }
            
            .filter-overlay {
                bottom: 15px;
                left: 15px;
            }
            
            .filter-btn {
                padding: 12px 20px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- ç™½ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ -->
    <div id="whiteFlash" class="white-flash"></div>

    <!-- ãƒ­ã‚´ï¼ˆãƒ›ãƒ¼ãƒ ãƒœã‚¿ãƒ³ï¼‰ -->
    <div class="logo-home" id="logoHome">
        <img src="logo_banner.png" alt="CJMBãƒãƒ£ãƒ³ãƒãƒ«">
    </div>

    <!-- å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
    <div id="deleteModeIndicator" class="delete-mode-indicator">
        ğŸ—‘ï¸ å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹ - ãƒ”ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å‰Šé™¤ (Ctrl+Shift+Dã§çµ‚äº†)
    </div>
    
    <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
    <div id="editModeIndicator" class="edit-mode-indicator">
        âœï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹ - ãƒ”ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç·¨é›† (Ctrl+Shift+Eã§çµ‚äº†)
    </div>

    <!-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ï¼‰ -->
    <div id="passwordConfirmModal" class="password-confirm-modal">
        <div class="password-confirm-content">
            <div class="password-confirm-title">ğŸ” å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰</div>
            <div class="password-confirm-description">å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</div>
            <div class="password-confirm-buttons" style="margin-top: 20px;">
                <button class="password-confirm-btn cancel" id="passwordCancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="password-confirm-btn confirm" id="deleteLoginGoogleBtn" style="background: #4285f4;">
                    <svg width="18" height="18" style="margin-right: 8px; vertical-align: middle;" viewBox="0 0 18 18">
                        <path fill="#fff" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"/>
                        <path fill="#fff" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2a4.8 4.8 0 0 1-7.18-2.54H1.83v2.07A8 8 0 0 0 8.98 17z"/>
                        <path fill="#fff" d="M4.5 10.52a4.8 4.8 0 0 1 0-3.04V5.41H1.83a8 8 0 0 0 0 7.18l2.67-2.07z"/>
                        <path fill="#fff" d="M8.98 4.18c1.17 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 0 0 1.83 5.4L4.5 7.49a4.77 4.77 0 0 1 4.48-3.3z"/>
                    </svg>
                    Googleã§ãƒ­ã‚°ã‚¤ãƒ³
                </button>
            </div>
        </div>
    </div>
    
    <!-- Googleãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰ -->
    <div id="editLoginModal" class="password-confirm-modal">
        <div class="password-confirm-content">
            <div class="password-confirm-title">âœï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</div>
            <div class="password-confirm-description">ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã«ã¯Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</div>
            <div class="password-confirm-buttons" style="margin-top: 20px;">
                <button class="password-confirm-btn cancel" id="editLoginCancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="password-confirm-btn confirm" id="editLoginGoogleBtn" style="background: #4285f4;">
                    <svg width="18" height="18" style="margin-right: 8px; vertical-align: middle;" viewBox="0 0 18 18">
                        <path fill="#fff" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"/>
                        <path fill="#fff" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2a4.8 4.8 0 0 1-7.18-2.54H1.83v2.07A8 8 0 0 0 8.98 17z"/>
                        <path fill="#fff" d="M4.5 10.52a4.8 4.8 0 0 1 0-3.04V5.41H1.83a8 8 0 0 0 0 7.18l2.67-2.07z"/>
                        <path fill="#fff" d="M8.98 4.18c1.17 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 0 0 1.83 5.4L4.5 7.49a4.77 4.77 0 0 1 4.48-3.3z"/>
                    </svg>
                    Googleã§ãƒ­ã‚°ã‚¤ãƒ³
                </button>
            </div>
        </div>
    </div>
    
    <!-- Googleãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆè¿½åŠ ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰ -->
    <div id="addLoginModal" class="password-confirm-modal">
        <div class="password-confirm-content">
            <div class="password-confirm-title">â• è¿½åŠ ãƒ¢ãƒ¼ãƒ‰</div>
            <div class="password-confirm-description">é«˜æ ¡ã‚’è¿½åŠ ã™ã‚‹ã«ã¯Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</div>
            <div class="password-confirm-buttons" style="margin-top: 20px;">
                <button class="password-confirm-btn cancel" id="addLoginCancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="password-confirm-btn confirm" id="addLoginGoogleBtn" style="background: #4285f4;">
                    <svg width="18" height="18" style="margin-right: 8px; vertical-align: middle;" viewBox="0 0 18 18">
                        <path fill="#fff" d="M16.51 8H8.98v3h4.3c-.18 1-.74 1.48-1.6 2.04v2.01h2.6a7.8 7.8 0 0 0 2.38-5.88c0-.57-.05-.66-.15-1.18z"/>
                        <path fill="#fff" d="M8.98 17c2.16 0 3.97-.72 5.3-1.94l-2.6-2a4.8 4.8 0 0 1-7.18-2.54H1.83v2.07A8 8 0 0 0 8.98 17z"/>
                        <path fill="#fff" d="M4.5 10.52a4.8 4.8 0 0 1 0-3.04V5.41H1.83a8 8 0 0 0 0 7.18l2.67-2.07z"/>
                        <path fill="#fff" d="M8.98 4.18c1.17 0 2.23.4 3.06 1.2l2.3-2.3A8 8 0 0 0 1.83 5.4L4.5 7.49a4.77 4.77 0 0 1 4.48-3.3z"/>
                    </svg>
                    Googleã§ãƒ­ã‚°ã‚¤ãƒ³
                </button>
            </div>
        </div>
    </div>

    <!-- å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="deleteConfirmModal" class="delete-confirm-modal">
        <div class="delete-confirm-content">
            <div class="delete-confirm-title">âš ï¸ å‰Šé™¤ç¢ºèª</div>
            <div class="delete-confirm-message" id="deleteConfirmMessage"></div>
            <div class="delete-confirm-buttons">
                <button class="delete-confirm-btn cancel" id="deleteCancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="delete-confirm-btn confirm" id="deleteConfirmBtn">å‰Šé™¤ã™ã‚‹</button>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <div class="controls-overlay">
        <div class="zoom-controls">
            <button class="zoom-btn" id="zoomIn">+</button>
            <button class="zoom-btn" id="zoomOut">âˆ’</button>
        </div>
    </div>

    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒœã‚¿ãƒ³ -->
    <div class="filter-overlay">
        <button class="filter-btn" id="filterBtn">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</button>
        <div class="filter-panel" id="filterPanel">
            <div class="filter-title">ã‚¿ã‚°ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</div>
            <div id="filterList"></div>
            <button class="filter-clear-btn" id="filterClearBtn">ã™ã¹ã¦è¡¨ç¤º</button>
        </div>
    </div>

    <div class="modal" id="addSchoolModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">é«˜æ ¡ã‚’è¿½åŠ </h2>
                <button class="close-btn" id="closeModal">Ã—</button>
            </div>

            <div class="password-section">
                <p>ğŸ”’ ç®¡ç†è€…å°‚ç”¨æ©Ÿèƒ½</p>
                <div class="form-group" id="passwordSection">
                    <label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ *</label>
                    <input type="password" id="password" placeholder="ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
                </div>
            </div>

            <form id="schoolForm">
                <div class="form-group">
                    <label for="schoolName">é«˜æ ¡ã®åå‰ *</label>
                    <input type="text" id="schoolName" required placeholder="ä¾‹: ã€‡ã€‡é«˜ç­‰å­¦æ ¡">
                </div>
                
                <div class="form-group">
                    <label for="coordinates">åº§æ¨™ (ç·¯åº¦, çµŒåº¦) *</label>
                    <input type="text" id="coordinates" required placeholder="ä¾‹: 34.648410, 134.991000">
                    <small style="color: #666; font-size: 0.85rem; margin-top: 5px; display: block;">Google Mapã§å³ã‚¯ãƒªãƒƒã‚¯â†’åº§æ¨™ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦è²¼ã‚Šä»˜ã‘</small>
                </div>
                
                <div class="form-group">
                    <label for="schoolDescription">è»½ã„ç´¹ä»‹æ–‡ *</label>
                    <textarea id="schoolDescription" required placeholder="ã“ã®é«˜æ ¡ã®ç‰¹å¾´ã‚„é­…åŠ›ã‚’æ›¸ã„ã¦ãã ã•ã„..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="schoolTags">ã‚¿ã‚°</label>
                    <input type="text" id="schoolTags" placeholder="ä¾‹: ç§ç«‹,å¥³å­æ ¡,å¹å¥æ¥½éƒ¨">
                    <small style="color: #666; font-size: 0.85rem; margin-top: 5px; display: block;">ã‚«ãƒ³ãƒï¼ˆ,ï¼‰ã§åŒºåˆ‡ã£ã¦å…¥åŠ›ã—ã¦ãã ã•ã„</small>
                </div>
                
                <div class="form-group">
                    <label for="youtubeUrl">YouTubeãƒªãƒ³ã‚¯ *</label>
                    <input type="url" id="youtubeUrl" required placeholder="https://www.youtube.com/watch?v=...">
                </div>
                
                <button type="button" class="submit-btn">ç™»éŒ²ã™ã‚‹</button>

                <div class="error-message" id="errorMessage"></div>
                <div class="success-message" id="successMessage"></div>
            </form>
        </div>
    </div>

    <!-- ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…å®¹è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="cluster-modal" id="clusterModal">
        <div class="cluster-modal-content">
            <div class="cluster-modal-header">
                <h3 id="clusterTitle">ã“ã®åœ°åŸŸã®é«˜æ ¡</h3>
                <button class="close-cluster-modal" id="closeClusterModal">Ã—</button>
            </div>
            <div class="cluster-modal-body" id="clusterList">
                <!-- ãƒ”ãƒ³ã®ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>
    
    <!-- Firebase SDK (v9 modular) -->
    <script type="module">
        // Firebase SDKã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, addDoc, deleteDoc, updateDoc, doc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        
        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyDFnND9Zk1YBgp4kAxvQbQTfDpwu7tG-1E",
            authDomain: "marching-band-map.firebaseapp.com",
            projectId: "marching-band-map",
            storageBucket: "marching-band-map.firebasestorage.app",
            messagingSenderId: "536001496114",
            appId: "1:536001496114:web:afb240991c54225b6ba82b"
        };
        
        // Firebaseã‚’åˆæœŸåŒ–
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«å…¬é–‹
        window.db = db;
        window.auth = auth;
        window.firebaseAuth = { signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, provider };
        window.firestoreLib = { collection, getDocs, addDoc, deleteDoc, updateDoc, doc, onSnapshot };
        
        console.log('FirebaseåˆæœŸåŒ–å®Œäº†');
    </script>
    
    <script>
        // ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
        const ADMIN_PASSWORD = '114514';
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let map;
        let schools = [];
        let customIcon;
        let markerCluster; // ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã‚’è¿½åŠ 
        let activeFilters = []; // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        let isEditMode = false; // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
        let currentUser = null; // ç¾åœ¨ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼
        let isAuthenticated = false; // èªè¨¼çŠ¶æ…‹

        // åœ°å›³ã®åˆæœŸåŒ–
        function initMap() {
            console.log('åœ°å›³ã‚’åˆæœŸåŒ–ä¸­...');
            
            // Firestoreã‹ã‚‰ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
            const { collection, onSnapshot } = window.firestoreLib;
            const schoolsRef = collection(window.db, 'schools');
            
            onSnapshot(schoolsRef, (snapshot) => {
                schools = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    schools.push({
                        id: doc.id,
                        name: data.name,
                        lat: data.lat,
                        lng: data.lng,
                        description: data.description,
                        tags: data.tags || [],
                        youtubeUrl: data.youtubeUrl,
                        createdAt: data.createdAt
                    });
                });
                
                console.log('Firestoreã‹ã‚‰èª­ã¿è¾¼ã¿:', schools.length, 'ä»¶');
                
                // åœ°å›³ã‚’æ›´æ–°
                updateMarkers();
            });
            
            // ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚«ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’ä½œæˆï¼ˆä¸¸å‹ã«å¤‰æ›´ï¼‰
            customIcon = L.divIcon({
                className: 'custom-marker',
                iconSize: [30, 30],
                iconAnchor: [15, 15],
                popupAnchor: [0, -15]
            });
            
            // æ—¥æœ¬ã®å¢ƒç•Œã‚’å®šç¾©
            const japanBounds = L.latLngBounds(
                L.latLng(24, 123),  // å—è¥¿ã®è§’ï¼ˆæ²–ç¸„ä»˜è¿‘ï¼‰
                L.latLng(46, 146)   // åŒ—æ±ã®è§’ï¼ˆåŒ—æµ·é“ä»˜è¿‘ï¼‰
            );
            
            // åœ°å›³ã‚’ä½œæˆ
            map = L.map('map', {
                zoomControl: false,
                preferCanvas: true,
                maxBounds: japanBounds,  // æ—¥æœ¬ã®ç¯„å›²ã«åˆ¶é™
                maxBoundsViscosity: 0.8  // å¢ƒç•Œã®ç²˜æ€§ï¼ˆ0-1ã€1ã§å®Œå…¨ã«åˆ¶é™ï¼‰
            }).setView([36.5, 138], 5);

            // ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ 
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 18,
                minZoom: 5  // æœ€å°ã‚ºãƒ¼ãƒ ã‚’5ã«å¤‰æ›´
            }).addTo(map);
            
            // ãƒãƒ¼ã‚«ãƒ¼ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆ
            markerCluster = L.markerClusterGroup({
                maxClusterRadius: function(zoom) {
                    // ã‚ºãƒ¼ãƒ ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ç¯„å›²ã‚’å‹•çš„ã«å¤‰æ›´
                    if (zoom >= 16) return 0;    // ã‚ºãƒ¼ãƒ 16ä»¥ä¸Š: ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ç„¡åŠ¹
                    if (zoom >= 14) return 30;   // ã‚ºãƒ¼ãƒ 14-15: 30pxä»¥å†…
                    if (zoom >= 12) return 60;   // ã‚ºãƒ¼ãƒ 12-13: 60pxä»¥å†…
                    if (zoom >= 10) return 100;  // ã‚ºãƒ¼ãƒ 10-11: 100pxä»¥å†…
                    return 150;                  // ã‚ºãƒ¼ãƒ 9ä»¥ä¸‹: 150pxä»¥å†…
                },
                spiderfyOnMaxZoom: false,
                showCoverageOnHover: false,
                zoomToBoundsOnClick: false, // è‡ªå‹•ã‚ºãƒ¼ãƒ ã‚’ç„¡åŠ¹åŒ–ï¼ˆæ‰‹å‹•ã§åˆ¶å¾¡ï¼‰
                animate: true,
                animateAddingMarkers: true,
                removeOutsideVisibleBounds: true,
                iconCreateFunction: function(cluster) {
                    const count = cluster.getChildCount();
                    const size = 50;
                    
                    return L.divIcon({
                        html: `<div style="
                            width: ${size}px;
                            height: ${size}px;
                            background: white;
                            border: 4px solid #10B981;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 16px;
                            font-weight: 700;
                            color: #059669;
                            font-family: 'Montserrat', sans-serif;
                            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
                        ">${count}</div>`,
                        className: 'custom-cluster-icon',
                        iconSize: L.point(size, size)
                    });
                }
            });
            
            // ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã‚«ã‚¹ã‚¿ãƒ å‡¦ç†
            let zoomCount = 0;
            markerCluster.on('clusterclick', function(a) {
                const cluster = a.layer;
                const childMarkers = cluster.getAllChildMarkers();
                
                // å­ãƒãƒ¼ã‚«ãƒ¼ãŒ1ã¤ã ã‘ã®å ´åˆã¯ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‹ã
                if (childMarkers.length === 1) {
                    childMarkers[0].openPopup();
                    return;
                }
                
                // ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼å†…ã®å…¨ã¦ã®ãƒãƒ¼ã‚«ãƒ¼ã®å¢ƒç•Œã‚’å–å¾—
                const bounds = cluster.getBounds();
                
                // å¢ƒç•Œã«åˆã‚ã›ã¦ã‚ºãƒ¼ãƒ ã¨ãƒ‘ãƒ³ã‚’å®Ÿè¡Œ
                // paddingã‚’è¨­å®šã—ã¦å…¨ã¦ã®ãƒ”ãƒ³ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
                map.fitBounds(bounds, {
                    padding: [50, 50], // ä¸Šä¸‹å·¦å³ã«50pxã®ä½™ç™½
                    maxZoom: 18,       // æœ€å¤§ã‚ºãƒ¼ãƒ ã‚’åˆ¶é™
                    animate: true,
                    duration: 0.5
                });
            });
            
            // ã‚ºãƒ¼ãƒ ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
            map.on('zoomend', function() {
                const currentZoom = map.getZoom();
                if (currentZoom >= 16) {
                    zoomCount = 0;
                }
            });
            
            map.addLayer(markerCluster);

            console.log('åœ°å›³ã®åˆæœŸåŒ–å®Œäº†');
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            setupEventListeners();
        }
        
        // ãƒãƒ¼ã‚«ãƒ¼ã‚’æ›´æ–°ï¼ˆFirestoreã‹ã‚‰èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ã§æ›´æ–°ï¼‰
        function updateMarkers() {
            // ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢
            markerCluster.clearLayers();
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
            if (activeFilters.length === 0) {
                schools.forEach(school => {
                    addMarkerToMap(school);
                });
            } else {
                schools.forEach(school => {
                    if (school.tags && school.tags.some(tag => activeFilters.includes(tag))) {
                        addMarkerToMap(school);
                    }
                });
            }
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ‘ãƒãƒ«ã‚’æ›´æ–°
            if (document.getElementById('filterList')) {
                updateFilterPanel();
            }
        }

        // YouTubeå‹•ç”»IDã‚’å–å¾—
        function getYouTubeID(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        // YouTubeã‚µãƒ ãƒã‚¤ãƒ«URLã‚’å–å¾—
        function getYouTubeThumbnail(videoId) {
            return `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
        }
        
        // YouTubeã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—ï¼ˆoEmbed APIã‚’ä½¿ç”¨ï¼‰
        async function getYouTubeTitle(videoId) {
            try {
                const response = await fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`);
                const data = await response.json();
                return data.title || '';
            } catch (error) {
                console.error('YouTubeã‚¿ã‚¤ãƒˆãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                return '';
            }
        }

        // ä½æ‰€ã‹ã‚‰åº§æ¨™ã‚’å–å¾—
        async function geocodeAddress(address) {
            try {
                console.log('ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°APIå‘¼ã³å‡ºã—:', address);
                
                // éƒµä¾¿ç•ªå·ã¨ã€Œã€’ã€è¨˜å·ã‚’å‰Šé™¤
                const cleanAddress = address.replace(/ã€’?\d{3}-?\d{4}\s*/g, '').trim();
                console.log('ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ãŸä½æ‰€:', cleanAddress);
                
                const url = `https://geolonia.github.io/japanese-addresses/api/ja/${encodeURIComponent(cleanAddress)}.json`;
                console.log('ãƒªã‚¯ã‚¨ã‚¹ãƒˆURL:', url);
                
                const response = await fetch(url);
                console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', response.status);
                
                if (!response.ok) {
                    console.log('APIã‚¨ãƒ©ãƒ¼ã€Nominatimã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯');
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: Nominatimã‚’è©¦ã™
                    return await geocodeWithNominatim(cleanAddress);
                }
                
                const data = await response.json();
                console.log('ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµæœ:', data);
                
                if (data && data.geometry && data.geometry.coordinates) {
                    const coords = {
                        lat: data.geometry.coordinates[1],
                        lng: data.geometry.coordinates[0]
                    };
                    console.log('åº§æ¨™å–å¾—æˆåŠŸ:', coords);
                    return coords;
                }
                
                console.log('çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                return null;
            } catch (error) {
                console.error('ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', error);
                return null;
            }
        }
        
        // Nominatimã§ã®ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
        async function geocodeWithNominatim(address) {
            try {
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&countrycodes=jp&limit=1`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                }
                return null;
            } catch (error) {
                console.error('Nominatimã‚¨ãƒ©ãƒ¼:', error);
                return null;
            }
        }

        // ãƒãƒ¼ã‚«ãƒ¼ã‚’åœ°å›³ã«è¿½åŠ 
        async function addMarkerToMap(school) {
            const marker = L.marker([school.lat, school.lng], { icon: customIcon });
            
            // ãƒãƒ¼ã‚«ãƒ¼ã«schoolãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            marker.schoolData = school;
            
            const videoId = getYouTubeID(school.youtubeUrl);
            const thumbnailUrl = videoId ? getYouTubeThumbnail(videoId) : '';
            
            console.log('YouTubeå‹•ç”»ID:', videoId);
            console.log('ã‚µãƒ ãƒã‚¤ãƒ«URL:', thumbnailUrl);
            
            // YouTubeã‚¿ã‚¤ãƒˆãƒ«ã‚’å–å¾—ï¼ˆéåŒæœŸï¼‰
            let youtubeTitle = '';
            if (videoId) {
                youtubeTitle = await getYouTubeTitle(videoId);
            }
            
            const popupContent = `
                <div class="popup-content">
                    <div class="popup-title">${school.name}</div>
                    ${school.tags && school.tags.length > 0 ? `
                        <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px; margin-bottom: 10px;">
                            ${school.tags.map(tag => `
                                <span style="
                                    background: #F0FDF4;
                                    color: #059669;
                                    padding: 4px 10px;
                                    border-radius: 12px;
                                    font-size: 12px;
                                    font-weight: 600;
                                    border: 1px solid #10B981;
                                ">${tag}</span>
                            `).join('')}
                        </div>
                    ` : ''}
                    <div class="popup-description">${school.description}</div>
                    ${thumbnailUrl ? `
                        <a href="${school.youtubeUrl}" target="_blank" rel="noopener noreferrer" style="display: block; margin-top: 10px; text-decoration: none;">
                            <img src="${thumbnailUrl}" alt="YouTubeå‹•ç”»" class="popup-thumbnail">
                        </a>
                        ${youtubeTitle ? `
                            <div class="youtube-title-text">${youtubeTitle}</div>
                        ` : ''}
                        </a>
                    ` : `
                        <a href="${school.youtubeUrl}" target="_blank" rel="noopener noreferrer" style="color: var(--primary); text-decoration: none; display: block; margin-top: 10px;">
                            ğŸ“º YouTubeå‹•ç”»ã‚’è¦‹ã‚‹ â†’
                        </a>
                    `}
                </div>
            `;
            
            marker.bindPopup(popupContent, {
                maxWidth: 320,
                minWidth: 250,
                className: 'custom-popup',
                autoClose: true,
                closeOnClick: true,
                autoPan: true,
                autoPanPadding: [10, 10]
            });
            
            // ãƒ”ãƒ³ã®ä¸‹ã«å­¦æ ¡åã‚’è¡¨ç¤ºï¼ˆå¸¸æ™‚è¡¨ç¤ºã®ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ï¼‰
            marker.bindTooltip(school.name, {
                permanent: true,
                direction: 'bottom',
                offset: [0, 10],
                className: 'marker-label'
            });
            
            // ãƒãƒ¼ã‚«ãƒ¼ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ
            marker.on('click', function(e) {
                console.log('ãƒãƒ¼ã‚«ãƒ¼ã‚¯ãƒªãƒƒã‚¯æ¤œå‡º');
                const deleteMode = document.body.classList.contains('delete-mode');
                console.log('å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰çŠ¶æ…‹:', deleteMode);
                console.log('ç·¨é›†ãƒ¢ãƒ¼ãƒ‰çŠ¶æ…‹:', isEditMode);
                
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
                if (isEditMode) {
                    // ã‚¤ãƒ™ãƒ³ãƒˆä¼æ’­ã‚’å®Œå…¨ã«åœæ­¢
                    if (e.originalEvent) {
                        e.originalEvent.preventDefault();
                        e.originalEvent.stopPropagation();
                    }
                    
                    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‹ã‹ãªã„ã‚ˆã†ã«ã™ã‚‹
                    marker.closePopup();
                    
                    console.log('ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤ºã—ã¾ã™');
                    
                    // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
                    showEditForm(school);
                    
                    return false;
                }
                
                // å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
                if (deleteMode) {
                    // ã‚¤ãƒ™ãƒ³ãƒˆä¼æ’­ã‚’å®Œå…¨ã«åœæ­¢
                    if (e.originalEvent) {
                        e.originalEvent.preventDefault();
                        e.originalEvent.stopPropagation();
                    }
                    
                    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‹ã‹ãªã„ã‚ˆã†ã«ã™ã‚‹
                    marker.closePopup();
                    
                    console.log('å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ã¾ã™');
                    
                    // ã‚«ã‚¹ã‚¿ãƒ å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                    showDeleteConfirmModal(school, marker);
                    
                    return false;
                }
            });
            
            // ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ 
            markerCluster.addLayer(marker);
        }
        
        // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
        function showEditForm(school) {
            console.log('showEditFormå‘¼ã³å‡ºã—:', school);
            
            const modal = document.getElementById('addSchoolModal');
            const modalTitle = modal.querySelector('h2');
            const form = document.getElementById('schoolForm');
            const submitBtn = form.querySelector('.submit-btn');
            const passwordSection = document.getElementById('passwordSection');
            
            console.log('ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ :', modal);
            console.log('ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ :', form);
            
            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’éè¡¨ç¤º
            if (passwordSection) {
                passwordSection.style.display = 'none';
            }
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¿ã‚¤ãƒˆãƒ«ã‚’å¤‰æ›´
            modalTitle.textContent = 'é«˜æ ¡æƒ…å ±ã‚’ç·¨é›†';
            submitBtn.textContent = 'æ›´æ–°ã™ã‚‹';
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã«æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›
            document.getElementById('schoolName').value = school.name;
            document.getElementById('schoolDescription').value = school.description;
            document.getElementById('youtubeUrl').value = school.youtubeUrl;
            
            // ã‚¿ã‚°ã‚’å¾©å…ƒï¼ˆãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›å½¢å¼ï¼‰
            const tagsInput = document.getElementById('schoolTags');
            if (tagsInput && school.tags) {
                tagsInput.value = school.tags.join(', ');
            }
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            modal.classList.add('active');
            
            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ç”¨ã®ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
            modal.dataset.editMode = 'true';
            modal.dataset.schoolId = school.id;
            
            console.log('ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºå®Œäº†:', school);
        }

        // å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        function showDeleteConfirmModal(school, marker) {
            const modal = document.getElementById('deleteConfirmModal');
            const message = document.getElementById('deleteConfirmMessage');
            const confirmBtn = document.getElementById('deleteConfirmBtn');
            const cancelBtn = document.getElementById('deleteCancelBtn');
            
            message.textContent = `ã€Œ${school.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`;
            modal.classList.add('active');
            
            // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
            const newConfirmBtn = confirmBtn.cloneNode(true);
            const newCancelBtn = cancelBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
            
            // å‰Šé™¤ç¢ºå®šãƒœã‚¿ãƒ³
            newConfirmBtn.addEventListener('click', () => {
                console.log('å‰Šé™¤å‡¦ç†é–‹å§‹');
                
                console.log('å‰Šé™¤å‡¦ç†é–‹å§‹');
                
                // Firestoreã‹ã‚‰å‰Šé™¤
                if (school.id) {
                    const { doc, deleteDoc } = window.firestoreLib;
                    const schoolDoc = doc(window.db, 'schools', school.id);
                    
                    deleteDoc(schoolDoc)
                        .then(() => {
                            console.log('Firestoreã‹ã‚‰å‰Šé™¤å®Œäº†:', school.name);
                        })
                        .catch((error) => {
                            console.error('Firestoreå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                        });
                } else {
                    console.log('å‰Šé™¤å¯¾è±¡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆIDãªã—ï¼‰');
                }
                
                modal.classList.remove('active');
            });
            
            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
            newCancelBtn.addEventListener('click', () => {
                console.log('å‰Šé™¤ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
                modal.classList.remove('active');
            });
            
            // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    console.log('å‰Šé™¤ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆèƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ï¼‰');
                    modal.classList.remove('active');
                }
            });
        }

        // ã™ã¹ã¦ã®ã‚¿ã‚°ã‚’å–å¾—
        function getAllTags() {
            const tagsSet = new Set();
            schools.forEach(school => {
                if (school.tags && Array.isArray(school.tags)) {
                    school.tags.forEach(tag => tagsSet.add(tag));
                }
            });
            return Array.from(tagsSet).sort();
        }
        
        // ã‚¿ã‚°ã”ã¨ã®å­¦æ ¡æ•°ã‚’å–å¾—
        function getSchoolCountByTag(tag) {
            return schools.filter(school => 
                school.tags && school.tags.includes(tag)
            ).length;
        }
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ‘ãƒãƒ«ã‚’æ›´æ–°
        function updateFilterPanel() {
            const filterList = document.getElementById('filterList');
            const allTags = getAllTags();
            
            if (allTags.length === 0) {
                filterList.innerHTML = '<div style="color: #9CA3AF; text-align: center; padding: 20px;">ã‚¿ã‚°ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
                return;
            }
            
            filterList.innerHTML = '';
            
            allTags.forEach(tag => {
                const count = getSchoolCountByTag(tag);
                const isActive = activeFilters.includes(tag);
                
                const filterItem = document.createElement('div');
                filterItem.className = 'filter-item' + (isActive ? ' active' : '');
                filterItem.innerHTML = `
                    <div class="filter-checkbox"></div>
                    <div class="filter-label">${tag}</div>
                    <div class="filter-count">${count}</div>
                `;
                
                filterItem.addEventListener('click', (e) => {
                    e.stopPropagation(); // ã‚¤ãƒ™ãƒ³ãƒˆä¼æ’­ã‚’åœæ­¢ã—ã¦ãƒ‘ãƒãƒ«ãŒé–‰ã˜ãªã„ã‚ˆã†ã«ã™ã‚‹
                    toggleFilter(tag);
                });
                
                filterList.appendChild(filterItem);
            });
        }
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®åˆ‡ã‚Šæ›¿ãˆ
        function toggleFilter(tag) {
            const index = activeFilters.indexOf(tag);
            
            if (index > -1) {
                // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è§£é™¤
                activeFilters.splice(index, 1);
            } else {
                // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¿½åŠ 
                activeFilters.push(tag);
            }
            
            updateFilterPanel();
            applyFilters();
        }
        
        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨
        function applyFilters() {
            // ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢
            markerCluster.clearLayers();
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã«åˆã†å­¦æ ¡ã‚’åœ°å›³ã«è¡¨ç¤º
            schools.forEach(school => {
                // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ãªã„å ´åˆã¯ã™ã¹ã¦è¡¨ç¤º
                if (activeFilters.length === 0) {
                    addMarkerToMap(school);
                } else {
                    // å­¦æ ¡ã®ã‚¿ã‚°ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ã„ãšã‚Œã‹ã«ä¸€è‡´ã™ã‚‹å ´åˆã®ã¿è¡¨ç¤º
                    if (school.tags && school.tags.some(tag => activeFilters.includes(tag))) {
                        addMarkerToMap(school);
                    }
                }
            });
            
            console.log('ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨:', activeFilters);
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        // ç·¨é›†å‡¦ç†
        async function handleEditSchool(schoolId) {
            const errorMsg = document.getElementById('errorMessage');
            const successMsg = document.getElementById('successMessage');
            const modal = document.getElementById('addSchoolModal');
            
            const name = document.getElementById('schoolName').value.trim();
            const description = document.getElementById('schoolDescription').value.trim();
            const youtubeUrl = document.getElementById('youtubeUrl').value.trim();
            
            // ã‚¿ã‚°ã‚’ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã‹ã‚‰å–å¾—
            const tagsInput = document.getElementById('schoolTags').value.trim();
            const tags = tagsInput ? tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0) : [];
            
            console.log('ç·¨é›†ãƒ‡ãƒ¼ã‚¿:', { schoolId, name, description, tags, youtubeUrl });
            
            // Firestoreã§æ›´æ–°
            const { doc, updateDoc } = window.firestoreLib;
            const schoolDoc = doc(window.db, 'schools', schoolId);
            
            try {
                await updateDoc(schoolDoc, {
                    name: name,
                    description: description,
                    tags: tags,
                    youtubeUrl: youtubeUrl,
                    updatedAt: new Date().toISOString()
                });
                
                console.log('æ›´æ–°å®Œäº†:', schoolId);
                
                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                successMsg.textContent = `${name}ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼`;
                successMsg.style.display = 'block';
                
                setTimeout(() => {
                    modal.classList.remove('active');
                    resetForm();
                    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
                    modal.dataset.editMode = 'false';
                    modal.dataset.schoolId = '';
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¿ã‚¤ãƒˆãƒ«ã‚’æˆ»ã™
                    modal.querySelector('h2').textContent = 'é«˜æ ¡ã‚’ç™»éŒ²';
                    modal.querySelector('.submit-btn').textContent = 'ç™»éŒ²ã™ã‚‹';
                }, 2000);
                
            } catch (error) {
                console.error('æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
                errorMsg.textContent = 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message;
                errorMsg.style.display = 'block';
            }
        }
        
        function resetForm() {
            const schoolForm = document.getElementById('schoolForm');
            const errorMsg = document.getElementById('errorMessage');
            const successMsg = document.getElementById('successMessage');
            const modal = document.getElementById('addSchoolModal');
            const passwordSection = document.getElementById('passwordSection');
            
            schoolForm.reset();
            document.getElementById('password').value = '';
            errorMsg.style.display = 'none';
            successMsg.style.display = 'none';
            
            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å†è¡¨ç¤º
            if (passwordSection) {
                passwordSection.style.display = 'block';
            }
            
            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
            modal.dataset.editMode = 'false';
            modal.dataset.schoolId = '';
            modal.querySelector('h2').textContent = 'é«˜æ ¡ã‚’ç™»éŒ²';
            modal.querySelector('.submit-btn').textContent = 'ç™»éŒ²ã™ã‚‹';
        }

        // ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        function showClusterModal(markers, clusterLatLng) {
            const modal = document.getElementById('clusterModal');
            const title = document.getElementById('clusterTitle');
            const listContainer = document.getElementById('clusterList');
            
            title.textContent = `ã“ã®åœ°åŸŸã®é«˜æ ¡ï¼ˆ${markers.length}æ ¡ï¼‰`;
            
            // ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
            listContainer.innerHTML = '';
            
            // å„ãƒãƒ¼ã‚«ãƒ¼ã®å­¦æ ¡æƒ…å ±ã‚’è¡¨ç¤º
            markers.forEach(marker => {
                const school = schools.find(s => 
                    s.lat === marker.getLatLng().lat && 
                    s.lng === marker.getLatLng().lng
                );
                
                if (!school) return;
                
                const videoId = getYouTubeID(school.youtubeUrl);
                const thumbnailUrl = videoId ? getYouTubeThumbnail(videoId) : '';
                
                const item = document.createElement('div');
                item.className = 'cluster-school-item';
                item.innerHTML = `
                    <div class="cluster-school-name">${school.name}</div>
                    <div class="cluster-school-description">${school.description}</div>
                    ${thumbnailUrl ? `<img src="${thumbnailUrl}" class="cluster-school-thumbnail" alt="${school.name}">` : ''}
                `;
                
                // ã‚¯ãƒªãƒƒã‚¯ã§ãƒãƒ¼ã‚«ãƒ¼ã«ç§»å‹•ã—ã¦ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‹ã
                item.addEventListener('click', () => {
                    modal.classList.remove('active');
                    map.setView([school.lat, school.lng], 17, { animate: true });
                    setTimeout(() => {
                        marker.openPopup();
                    }, 500);
                });
                
                listContainer.appendChild(item);
            });
            
            modal.classList.add('active');
        }

        // ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('clusterModal');
            const closeBtn = document.getElementById('closeClusterModal');
            
            closeBtn.addEventListener('click', () => {
                modal.classList.remove('active');
            });
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        function setupEventListeners() {
            const modal = document.getElementById('addSchoolModal');
            const closeModalBtn = document.getElementById('closeModal');
            const schoolForm = document.getElementById('schoolForm');
            const errorMsg = document.getElementById('errorMessage');
            const successMsg = document.getElementById('successMessage');

            console.log('ãƒ¢ãƒ¼ãƒ€ãƒ«:', modal);
            console.log('ãƒ•ã‚©ãƒ¼ãƒ :', schoolForm);
            console.log('ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', errorMsg);
            console.log('æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', successMsg);
            
            // èªè¨¼çŠ¶æ…‹ã‚’ç›£è¦–
            const { onAuthStateChanged } = window.firebaseAuth;
            onAuthStateChanged(window.auth, (user) => {
                if (user) {
                    // ãƒ­ã‚°ã‚¤ãƒ³ä¸­
                    currentUser = user;
                    isAuthenticated = true;
                    console.log('ãƒ­ã‚°ã‚¤ãƒ³ä¸­:', user.email);
                } else {
                    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆä¸­
                    currentUser = null;
                    isAuthenticated = false;
                    isEditMode = false; // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’è‡ªå‹•çš„ã«OFF
                    console.log('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆä¸­');
                }
            });

            // ãƒ­ã‚´ã‚¯ãƒªãƒƒã‚¯ã§ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
            const logoHome = document.getElementById('logoHome');
            const whiteFlash = document.getElementById('whiteFlash');
            
            logoHome.addEventListener('click', () => {
                // ç™½ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                whiteFlash.classList.add('active');
                
                setTimeout(() => {
                    // åœ°å›³ã‚’åˆæœŸä½ç½®ã«æˆ»ã™
                    map.setView([36.5, 138], 5, {
                        animate: true,
                        duration: 1
                    });
                    
                    // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚’æ¶ˆã™
                    setTimeout(() => {
                        whiteFlash.classList.remove('active');
                    }, 150);
                }, 150);
            });

            // å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ã®çŠ¶æ…‹ç®¡ç†
            let deleteMode = false;
            const deleteModeIndicator = document.getElementById('deleteModeIndicator');
            const passwordConfirmModal = document.getElementById('passwordConfirmModal');
            const passwordCancelBtn = document.getElementById('passwordCancelBtn');
            
            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®çŠ¶æ…‹ç®¡ç†ï¼ˆGoogleãƒ­ã‚°ã‚¤ãƒ³ç‰ˆï¼‰
            const editModeIndicator = document.getElementById('editModeIndicator');
            const editLoginModal = document.getElementById('editLoginModal');
            const editLoginGoogleBtn = document.getElementById('editLoginGoogleBtn');
            const editLoginCancelBtn = document.getElementById('editLoginCancelBtn');

            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            function showPasswordConfirmModal() {
                passwordConfirmModal.classList.add('active');
            }

            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            function closePasswordConfirmModal() {
                passwordConfirmModal.classList.remove('active');
            }

            // å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ç”¨Googleãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³
            const deleteLoginGoogleBtn = document.getElementById('deleteLoginGoogleBtn');
            deleteLoginGoogleBtn.addEventListener('click', async () => {
                try {
                    const { signInWithPopup, provider } = window.firebaseAuth;
                    const result = await signInWithPopup(window.auth, provider);
                    console.log('å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ç”¨ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ:', result.user.email);
                    
                    // å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ON
                    deleteMode = true;
                    deleteModeIndicator.classList.add('active');
                    document.body.classList.add('delete-mode');
                    closePasswordConfirmModal();
                    console.log('å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰: ON');
                } catch (error) {
                    console.error('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                    alert('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            });

            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
            passwordCancelBtn.addEventListener('click', () => {
                closePasswordConfirmModal();
                console.log('å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰: ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
            });

            // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            passwordConfirmModal.addEventListener('click', (e) => {
                if (e.target === passwordConfirmModal) {
                    closePasswordConfirmModal();
                }
            });
            
            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ç”¨Googleãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢æ•°
            function showEditLoginModal() {
                editLoginModal.classList.add('active');
            }
            
            function closeEditLoginModal() {
                editLoginModal.classList.remove('active');
            }
            
            // Googleãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³
            editLoginGoogleBtn.addEventListener('click', async () => {
                try {
                    const { signInWithPopup, provider } = window.firebaseAuth;
                    const result = await signInWithPopup(window.auth, provider);
                    const user = result.user;
                    
                    console.log('ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ:', user.email);
                    
                    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ON
                    isEditMode = true;
                    editModeIndicator.classList.add('active');
                    closeEditLoginModal();
                    console.log('ç·¨é›†ãƒ¢ãƒ¼ãƒ‰: ON');
                    
                } catch (error) {
                    console.error('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                    alert('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            });
            
            // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
            editLoginCancelBtn.addEventListener('click', () => {
                closeEditLoginModal();
                console.log('ç·¨é›†ãƒ¢ãƒ¼ãƒ‰: ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
            });
            
            // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            editLoginModal.addEventListener('click', (e) => {
                if (e.target === editLoginModal) {
                    closeEditLoginModal();
                }
            });
            
            // è¿½åŠ ãƒ¢ãƒ¼ãƒ‰ç”¨Googleãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«
            const addLoginModal = document.getElementById('addLoginModal');
            const addLoginGoogleBtn = document.getElementById('addLoginGoogleBtn');
            const addLoginCancelBtn = document.getElementById('addLoginCancelBtn');
            
            function showAddLoginModal() {
                addLoginModal.classList.add('active');
            }
            
            function closeAddLoginModal() {
                addLoginModal.classList.remove('active');
            }
            
            // è¿½åŠ ãƒ¢ãƒ¼ãƒ‰ç”¨Googleãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³
            addLoginGoogleBtn.addEventListener('click', async () => {
                try {
                    const { signInWithPopup, provider } = window.firebaseAuth;
                    const result = await signInWithPopup(window.auth, provider);
                    console.log('è¿½åŠ ãƒ¢ãƒ¼ãƒ‰ç”¨ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ:', result.user.email);
                    
                    closeAddLoginModal();
                    
                    // ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‹ã
                    const passwordSection = document.getElementById('passwordSection');
                    passwordSection.style.display = 'none';
                    modal.classList.add('active');
                } catch (error) {
                    console.error('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                    alert('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            });
            
            // è¿½åŠ ãƒ¢ãƒ¼ãƒ‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
            addLoginCancelBtn.addEventListener('click', () => {
                closeAddLoginModal();
            });
            
            // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            addLoginModal.addEventListener('click', (e) => {
                if (e.target === addLoginModal) {
                    closeAddLoginModal();
                }
            });

            // Ctrl+Shift+A ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
            // Ctrl+Shift+D ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚­ãƒ¼ã§å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆ
            // Ctrl+Shift+E ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚­ãƒ¼ã§ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆ
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey && e.shiftKey && e.key === 'A') {
                    e.preventDefault();
                    // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãªã‚‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¬„ã‚’éè¡¨ç¤ºã—ã¦ç›´æ¥é–‹ã
                    if (isAuthenticated) {
                        const passwordSection = document.getElementById('passwordSection');
                        passwordSection.style.display = 'none';
                        modal.classList.add('active');
                    } else {
                        // æœªãƒ­ã‚°ã‚¤ãƒ³ãªã‚‰Googleãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                        showAddLoginModal();
                    }
                }
                
                if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                    e.preventDefault();
                    
                    if (!deleteMode) {
                        // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãªã‚‰ãã®ã¾ã¾å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ON
                        if (isAuthenticated) {
                            deleteMode = true;
                            deleteModeIndicator.classList.add('active');
                            document.body.classList.add('delete-mode');
                            console.log('å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰: ON');
                        } else {
                            // æœªãƒ­ã‚°ã‚¤ãƒ³ãªã‚‰Googleãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                            showPasswordConfirmModal();
                        }
                    } else {
                        // å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰OFF
                        deleteMode = false;
                        deleteModeIndicator.classList.remove('active');
                        document.body.classList.remove('delete-mode');
                        console.log('å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰: OFF');
                    }
                }
                
                // Ctrl+Shift+E: ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
                if (e.ctrlKey && e.shiftKey && e.key === 'E') {
                    e.preventDefault();
                    
                    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’ONã«ã™ã‚‹å ´åˆ
                    if (!isEditMode) {
                        // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãªã‚‰ãã®ã¾ã¾ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ON
                        if (isAuthenticated) {
                            isEditMode = true;
                            editModeIndicator.classList.add('active');
                            console.log('ç·¨é›†ãƒ¢ãƒ¼ãƒ‰: ON');
                        } else {
                            // æœªãƒ­ã‚°ã‚¤ãƒ³ãªã‚‰Googleãƒ­ã‚°ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                            showEditLoginModal();
                        }
                    } else {
                        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰OFF
                        isEditMode = false;
                        editModeIndicator.classList.remove('active');
                        console.log('ç·¨é›†ãƒ¢ãƒ¼ãƒ‰: OFF');
                    }
                }
            });

            // ãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œ
            closeModalBtn.addEventListener('click', () => {
                modal.classList.remove('active');
                resetForm();
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                    resetForm();
                }
            });

            // ã‚ºãƒ¼ãƒ ãƒœã‚¿ãƒ³
            document.getElementById('zoomIn').addEventListener('click', () => {
                map.zoomIn();
            });

            document.getElementById('zoomOut').addEventListener('click', () => {
                map.zoomOut();
            });

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³
            const filterBtn = document.getElementById('filterBtn');
            const filterPanel = document.getElementById('filterPanel');
            const filterClearBtn = document.getElementById('filterClearBtn');
            
            filterBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // ã‚¤ãƒ™ãƒ³ãƒˆä¼æ’­ã‚’åœæ­¢
                filterPanel.classList.toggle('active');
                updateFilterPanel();
            });
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
            filterClearBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // ã‚¤ãƒ™ãƒ³ãƒˆä¼æ’­ã‚’åœæ­¢
                activeFilters = [];
                updateFilterPanel();
                applyFilters();
            });
            
            // ãƒ‘ãƒãƒ«å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰é–‰ã˜ã‚‹
            document.addEventListener('click', (e) => {
                if (!filterBtn.contains(e.target) && !filterPanel.contains(e.target)) {
                    filterPanel.classList.remove('active');
                }
            });

            // ç™»éŒ²ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            const submitBtn = document.querySelector('.submit-btn');
            console.log('ç™»éŒ²ãƒœã‚¿ãƒ³:', submitBtn);
            
            submitBtn.addEventListener('click', async (e) => {
                console.log('ç™»éŒ²ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
                
                errorMsg.style.display = 'none';
                successMsg.style.display = 'none';
                
                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‹ãƒã‚§ãƒƒã‚¯
                const isEdit = modal.dataset.editMode === 'true';
                const schoolId = modal.dataset.schoolId;
                
                if (isEdit) {
                    // ç·¨é›†å‡¦ç†
                    await handleEditSchool(schoolId);
                    return;
                }
                
                // ä»¥ä¸‹ã¯æ–°è¦ç™»éŒ²å‡¦ç†
                
                // èªè¨¼ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¾ãŸã¯Googleãƒ­ã‚°ã‚¤ãƒ³ï¼‰
                const password = document.getElementById('password').value;
                const isPasswordValid = password === ADMIN_PASSWORD;
                
                if (!isAuthenticated && !isPasswordValid) {
                    errorMsg.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ããªã„ã‹ã€Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„';
                    errorMsg.style.display = 'block';
                    console.log('èªè¨¼ã‚¨ãƒ©ãƒ¼');
                    return;
                }
                
                const name = document.getElementById('schoolName').value.trim();
                const coordinatesInput = document.getElementById('coordinates').value.trim();
                const description = document.getElementById('schoolDescription').value.trim();
                const tagsInput = document.getElementById('schoolTags').value.trim();
                const youtubeUrl = document.getElementById('youtubeUrl').value.trim();
                
                // ã‚¿ã‚°ã‚’é…åˆ—ã«åˆ†å‰²ï¼ˆã‚«ãƒ³ãƒã§åŒºåˆ‡ã‚‹ï¼‰
                const tags = tagsInput ? tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0) : [];
                
                console.log('å…¥åŠ›ãƒ‡ãƒ¼ã‚¿:', { name, coordinatesInput, description, tags, youtubeUrl });
                
                // åº§æ¨™ã‚’åˆ†é›¢ï¼ˆã‚«ãƒ³ãƒã€ã‚¹ãƒšãƒ¼ã‚¹ã€ã‚¿ãƒ–ãªã©ã§åŒºåˆ‡ã‚‰ã‚Œã¦ã„ã‚‹å ´åˆã«å¯¾å¿œï¼‰
                const coordParts = coordinatesInput.split(/[,\s]+/).filter(p => p.length > 0);
                
                if (coordParts.length < 2) {
                    errorMsg.textContent = 'åº§æ¨™ã¯ã€Œç·¯åº¦, çµŒåº¦ã€ã®å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: 34.648410, 134.991000ï¼‰';
                    errorMsg.style.display = 'block';
                    console.log('åº§æ¨™ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¨ãƒ©ãƒ¼:', coordParts);
                    return;
                }
                
                // ç·¯åº¦ãŒ1ç•ªç›®ã€çµŒåº¦ãŒ2ç•ªç›®
                const lat = parseFloat(coordParts[0]);
                const lng = parseFloat(coordParts[1]);
                
                console.log('åˆ†é›¢ã—ãŸåº§æ¨™:', { lat, lng });
                
                if (isNaN(lat) || isNaN(lng)) {
                    errorMsg.textContent = 'ç·¯åº¦ãƒ»çµŒåº¦ã¯æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„';
                    errorMsg.style.display = 'block';
                    console.log('åº§æ¨™æ•°å€¤ã‚¨ãƒ©ãƒ¼');
                    return;
                }
                
                if (lat < 24 || lat > 46 || lng < 123 || lng > 146) {
                    errorMsg.textContent = 'åº§æ¨™ãŒæ—¥æœ¬ã®ç¯„å›²å¤–ã§ã™ã€‚æ­£ã—ã„åº§æ¨™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                    errorMsg.style.display = 'block';
                    console.log('åº§æ¨™ç¯„å›²ã‚¨ãƒ©ãƒ¼');
                    return;
                }
                
                // YouTube URLã®æ¤œè¨¼
                if (!getYouTubeID(youtubeUrl)) {
                    errorMsg.textContent = 'æœ‰åŠ¹ãªYouTube URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                    errorMsg.style.display = 'block';
                    console.log('YouTube URLã‚¨ãƒ©ãƒ¼');
                    return;
                }
                
                // å­¦æ ¡ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
                const school = {
                    name,
                    lat,
                    lng,
                    description,
                    tags,
                    youtubeUrl,
                    createdAt: new Date().toISOString()
                };
                
                console.log('å­¦æ ¡ãƒ‡ãƒ¼ã‚¿ä½œæˆ:', school);
                
                // Firestoreã«ä¿å­˜
                const { collection, addDoc } = window.firestoreLib;
                const schoolsRef = collection(window.db, 'schools');
                
                addDoc(schoolsRef, school)
                    .then((docRef) => {
                        console.log('Firestoreã«ä¿å­˜å®Œäº†:', docRef.id);
                        
                        // åœ°å›³ã‚’ãã®ä½ç½®ã«ç§»å‹•
                        map.setView([lat, lng], 12);
                        
                        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                        successMsg.textContent = `${name}ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼`;
                        successMsg.style.display = 'block';
                        console.log('ç™»éŒ²å®Œäº†');
                        
                        setTimeout(() => {
                            modal.classList.remove('active');
                            resetForm();
                        }, 2000);
                    })
                    .catch((error) => {
                        console.error('Firestoreä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                        errorMsg.textContent = 'ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message;
                        errorMsg.style.display = 'block';
                    });
            });

        }
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åœ°å›³ã‚’åˆæœŸåŒ–
        window.addEventListener('load', function() {
            console.log('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            
            // Firebaseã®æº–å‚™ãŒã§ãã‚‹ã¾ã§å¾…æ©Ÿ
            function waitForFirebase() {
                if (window.db && window.firestoreLib) {
                    console.log('Firebaseæº–å‚™å®Œäº†ã€åœ°å›³ã‚’åˆæœŸåŒ–ã—ã¾ã™');
                    initMap();
                } else {
                    console.log('Firebaseã®æº–å‚™ã‚’å¾…æ©Ÿä¸­...');
                    setTimeout(waitForFirebase, 100);
                }
            }
            
            waitForFirebase();
        });
    </script>
</body>
</html>